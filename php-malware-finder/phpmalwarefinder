#!/usr/bin/env bash

set -o errexit
set -o errtrace
set -o nounset
set -o pipefail
# set -o xtrace

yara=$(type -P yara)
config_path='/etc/phpmalwarefinder/php.yar'

if [ ! -x "${yara}" ]
then
    yara='./yara'
    if [ ! -x "${yara}" ]
    then
        echo 'Unable to find yara in your ${PATH}, and in the current directory.'
        exit 0
    fi
fi

if [ ! -f "${config_path}" ]
then
    config_path="$(dirname "${0}")/php.yar"
fi

needle_in_haystack() {

  needle=$(mktemp)
  grep -E '(PasswordProtection|Websites|TooShort|NonPrintableChars)' ${1} > ${needle}
  if [ ! "$(wc -l "${needle}" | awk '{print $1}')" = "0" ]; then
      echo "================================================="
      echo "You should take a look at the files listed below:"
      cat "${needle}"
  fi;
  rm "${needle}"
}

show_help() {
    cat << EOF
Usage ${0##*/} [-cfhtvl] <file|folder> ...
    -c  Optional path to a rule file
    -f  Fast mode
    -h  Show this help message
    -t  Specify the number of threads to use (8 by default)
    -v  Verbose mode
EOF
}

OPTIND=1
set +o nounset
while getopts "c:fht:v" opt; do
    case "${opt}" in
        c)
            config_path=${optarg}
            ;;
        f)
            opts="${opts} -f"
            ;;
        h)
            show_help
            exit 0
            ;;
        t)
            opts="${opts} --threads=${optarg}"
            ;;
        v)
            opts="${opts} -s"
            ;;
        '?')
            show_help
            exit 1
            ;;
    esac
done
set -o nounset
shift "$((OPTIND-1))"

if [ ! -e "${config_path}" ]
then
    echo "The configuration file ${config_path} doesn't exist. Please give me a valid file."
    exit 1
fi

if [ -z "${@}" ]
then
    show_help
    exit 1
fi


# Include correct yara rule
opts="${opts} -r ${config_path}"

# Copy outpout to temporary file
output=$(mktemp)
# delete trailing slash for directories to prevent double slash (issue #40)
target=$(echo "${@}" | sed s'#/$##')
# Execute rules
${yara} ${opts} ${target} |tee ${output} 

needle_in_haystack "${output}"
rm "${output}"
